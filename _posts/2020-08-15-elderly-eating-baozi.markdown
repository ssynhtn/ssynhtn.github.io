---
layout: post
title:  "Dining philosopher"
date:   2020-08-15 18:20:26 +0800
categories: concurrency
---

这个问题似乎一般翻译成哲学家就餐问题  
我觉得太文邹邹的了，还是把它叫成智者吃饭问题比较好，但是似乎长者吃包子更好呢  

这个问题演示了死锁的现象  

但是对于这个目的来说，它有点复杂，因为5个长者是围坐在桌子上，而这种环形的结构总是比纯线形的结构要tricky一些  

<!-- 在线形的结构中，我们能说第i个长者必须拿起第i和i+1的筷子才能吃到包子，但是如果是坐成一圈，这个条件就修改为第i个长者必须拿起第i和(i+1)%n的筷子才能吃到包子，也许对于那些数论和群论谙熟于心的人来说这是一回事，因为在剩余类中n==0，不过反正我不是这样的人   -->

死锁的情况不难想象，当所有的长者都恰好拿起了左边的筷子，这时每个长者都想去拿右边的筷子，没有一个长者能继续运行下去，于是就卡住了  
所有的长者都恰好拿起了右边的筷子也是一种情况  

从好的方向去看，至少长者的时间凝固了，你不再需要给他续一秒了  

这个问题有一个常见的解决方法，大致上是：我们要求一个长者总是先拿右边的筷子，再拿左边的筷子，其它长者则相反  

但是我一直不太明白这个解决方法的出发点在哪里，现在我想明白了(也许对有些人来说这是显而易见的，但是每个人总会碰到很多让他不觉得显而易见的问题)  

在我给出对这个解决方法的动机的理解之前，我们不妨先直接地证明这个方法的正确性  

我们首先给长者按逆时针顺序编号，其中0，1，2，3的长者都是先拿左边的筷子，4号长者会先拿右边的筷子  
同样我们把筷子也编号，每个长者左边的筷子和他的编号一样，这样0号和4号长者中间的筷子就是0号筷子，此时第i个长者都想拿起i和i+1的筷子，而第i个筷子能被i-1和i的长者拿起

![哲学家就餐]({{ "/assets/dinner/dinner.png" | absolute_url }})

我们注意到0号长者和4号长者因为撇性不同，都要先拿起0号筷子，因此他们总是有一个人是两手空空的（或者两人都是），换句话说：

任何一个时刻，手里拿着筷子的长者数至多为4，因此我们可以这么证明这个方案的正确性：
  * 如果5个筷子都被拿起，由于手持筷子的长者数至多为4，根据鸽笼原理，至少有一个长者拿到了2个筷子，他可以吃包子并放下筷子
    * 如果有筷子未被拿起，那么：
      * 如果0，1，2，3这四个筷子中有未被拿起的，那么它们可以被对应编号的长者拿起
      * 如果0，1，2，3这四个筷子都已经被拿起，只有4未被拿起，那么：
        * 如果3这个筷子是被3号长者拿起，那么他可以拿起4号筷子并吃包子
        * 如果3这个筷子是被2号长者拿起，那么他已经手持2个筷子，可以吃包子了


挺不错的证明吧？不仅思路清晰，而且我们也能看出这个解决方案能解决问题的原因就在于0号和4号长者因为竞争0号筷子，使得他们至少一人为空手，避免了前面提到的那两种死锁情况

如果想得更仔细一些，可以发现其实重要的一点是：上面描述的这两种死锁情况，是原问题（不限制长者拿左右筷子的顺序）中唯二的会出现死锁的情况，原因：
  * 如果有筷子还没被拿起，那么这个筷子两边的长者都可以拿起它
  * 如果所有的筷子都被拿起，那么：
    * 如果有一个长者拿起了两个筷子，那么他可以吃包子，然后放下筷子
    * 如果每个长者都拿起了一个筷子，我们可以断定这就是上面描述的两种情况之一，原因是：
      * 相邻的两个长者肯定拿起了同侧的筷子（否则他们中间的筷子就还没被拿起），因此所有的长者都拿起了同侧的筷子

在证明了死锁情况的唯一性之后，再证明我们的方案的正确性就只需要一句话了，因为0号和4号长者竞争0号筷子，导致至少有一个长者没有拿起筷子，因为不可能进入人手一筷的状态，因此就不会死锁



